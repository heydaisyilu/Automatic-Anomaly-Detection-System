# Thông báo khi có bất thường
name: Notify anomalies by issue

on:
  workflow_run:
    workflows: ["Detect AQI Anomalies"]
    types: [completed]
  workflow_dispatch:
    inputs:
      demo:
        description: "Gửi thông báo DEMO ngay"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  issues: write

# Tránh chồng chéo giữa các lần chạy
concurrency:
  group: notify-${{ github.event.workflow_run.id || github.run_id }}
  cancel-in-progress: false

jobs:
  notify:
    # Chạy khi detect thành công hoặc khi bấm tay
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest

    steps:
      # Luôn checkout nhánh đã chạy detect (thường là main); đảm bảo có commit bot vừa push
      - name: Checkout branch (has latest anomaly commit)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || 'main' }}
          fetch-depth: 0

      - name: Debug context
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "head_branch=${{ github.event.workflow_run.head_branch }}"
          echo "head_sha=${{ github.event.workflow_run.head_sha }}"
          echo "current_tip=$(git rev-parse HEAD)"
          git log --oneline -3 || true

      # Python env
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      # So sánh file thay đổi do detect push: BASE = head_sha (trước khi detect tự commit), HEAD = tip của nhánh
      - name: Collect changed anomaly files (only on workflow_run)
        id: diff
        if: ${{ github.event_name == 'workflow_run' }}
        env:
          BASE_SHA: ${{ github.event.workflow_run.head_sha }}
          BRANCH: ${{ github.event.workflow_run.head_branch || github.event.repository.default_branch }}
        run: |
          set -e
          if git rev-parse --is-shallow-repository >/dev/null 2>&1 && git rev-parse --is-shallow-repository | grep -q true; then
            git fetch --unshallow --no-tags --prune origin
          else
            git fetch --no-tags --prune origin
          fi
          git checkout -q "$BRANCH"
          git pull --ff-only --no-tags

          CHANGED="$(git diff --name-only "$BASE_SHA..HEAD" -- \
            result_anomaly \
            detection/detection_output.ipynb || true)"
          echo "changed files:"
          echo "$CHANGED"

          {
            printf 'files<<EOF\n'
            printf '%s\n' "$CHANGED"
            printf 'EOF\n'
          } >> "$GITHUB_OUTPUT"

      # DEMO (chạy tay)
      - name: Build DEMO report (manual run)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.demo }}
        run: |
          mkdir -p out
          cat > out/anomaly_email.md <<'MD'
          #  Cảnh báo bất thường AQI/Gió (DEMO)
          |  Thành phố  | Thời điểm (UTC+7) | AQI | Gió | Phương pháp | Nguồn |
          |-------------|-------------------|-----|-----|-------------|-------|
          | Ho Chi Minh City | 2025-08-16 19:00 | 180 | 12.30 | Z-score AQI, Z-score Wind | result_anomaly/z_score/ho_chi_minh_zscore.csv |
          | Ho Chi Minh City | 2025-08-16 19:00 | 175 | 11.80 | IsolationForest | result_anomaly/isolation_forest/anomalies_ho_chi_minh_2025.csv |
          MD

      # Render (tự động sau detect, hoặc khi chạy tay)
      - name: Render report (auto run after detect)
        if: ${{ (github.event_name == 'workflow_run' && steps.diff.outputs.files != '') || github.event_name == 'workflow_dispatch' }}
        env:
          CHANGED_FILES: ${{ steps.diff.outputs.files }}
          ASSUME_TZ: Asia/Ho_Chi_Minh
        run: |
          python notify/render_email.py

      # Tạo/cập nhật Issue thông báo
      - name: Create/Update alert issue and ping you
        if: hashFiles('out/anomaly_email.md') != ''
        uses: actions/github-script@v7
        env:
          PING_USER: heydaisyilu
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('out/anomaly_email.md', 'utf8');
            const {owner, repo} = context.repo;
            const title = 'AQI/Gió bất thường — Live feed';

            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {owner, repo, state: 'open', per_page: 100}
            );
            let issue = issues.find(i => i.title === title);

            if (!issue) {
              const res = await github.rest.issues.create({ owner, repo, title, body });
              issue = res.data;
            } else {
              await github.rest.issues.update({ owner, repo, issue_number: issue.number, body });
            }

            const ping = process.env.PING_USER ? `@${process.env.PING_USER}` : '';
            const dt = new Date();
            const vnTime = dt.toLocaleString('sv-SE', { timeZone: 'Asia/Ho_Chi_Minh' }).replace(' ', 'T');
            await github.rest.issues.createComment({
              owner, repo, issue_number: issue.number,
              body: `Cập nhật: ${vnTime} (Asia/Ho_Chi_Minh) ${ping}`
            });

      # Gửi email khi có báo cáo
      - name: Send email if anomalies detected
        if: hashFiles('out/anomaly_email.md') != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Cảnh báo AQI/Gió bất thường"
          to: huynhthaibaongan.d@gmail.com, tonyphuc9999@gmail.com
          from: AQI Alert Bot <aqi-bot@example.com>
          content_type: text/markdown
          body: file://out/anomaly_email.md