name: Notify anomalies by issue

on:
  workflow_run:
    workflows: ["Detect AQI Anomalies"]
    types: [completed]
  workflow_dispatch:
    inputs:
      demo:
        description: "Gá»­i thÃ´ng bÃ¡o DEMO ngay"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  issues: write   # cáº§n quyá»n nÃ y Ä‘á»ƒ táº¡o/cáº­p nháº­t Issue (qua GITHUB_TOKEN) 

jobs:
  notify:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout at detect commit (if workflow_run)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || '' }}
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      - name: Collect changed anomaly files (only on workflow_run)
        id: diff
        if: ${{ github.event_name == 'workflow_run' }}
        run: |
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED="$(git diff --name-only HEAD~1 HEAD -- result_anomaly || true)"
          else
            CHANGED="$(git ls-files result_anomaly || true)"
          fi
          echo "$CHANGED"
          CHANGED_ESCAPED="$(printf "%s" "$CHANGED" | sed -e 's/%/%25/g' -e 's/\r/%0D/g' -e 's/\n/%0A/g')"
          echo "files=$CHANGED_ESCAPED" >> "$GITHUB_OUTPUT"

      - name: Build DEMO report (manual run)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.demo }}
        run: |
          mkdir -p out
          cat > out/anomaly_email.md <<'MD'
          # ðŸš¨ Cáº£nh bÃ¡o báº¥t thÆ°á»ng AQI/GiÃ³ (DEMO)
          | ThÃ nh phá»‘ | Thá»i Ä‘iá»ƒm (UTC) | AQI | GiÃ³ | PhÆ°Æ¡ng phÃ¡p | Nguá»“n |
          |---|---:|---:|---:|---|---|
          | Ho Chi Minh City | 2025-08-16 12:00 | 180 | 12.3 | Z-score, IF | result_anomaly/demo.csv |
          MD

      - name: Render report (auto run after detect)
        if: ${{ github.event_name == 'workflow_run' && steps.diff.outputs.files != '' }}
        env:
          CHANGED_FILES: ${{ steps.diff.outputs.files }}
        run: |
          python notify/render_email.py

      - name: Create/Update alert issue and ping you
        if: hashFiles('out/anomaly_email.md') != ''
        uses: actions/github-script@v7
        env:
          PING_USER: your_github_username   # TODO: Ä‘á»•i thÃ nh username cá»§a báº¡n, vÃ­ dá»¥: tony123
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            const body = fs.readFileSync('out/anomaly_email.md', 'utf8');
            const {owner, repo} = context.repo;
            const title = 'ðŸš¨ AQI/GiÃ³ báº¥t thÆ°á»ng â€” Live feed';

            // Try find open issue with the same title
            const {data: issues} = await github.rest.issues.listForRepo({
              owner, repo, state: 'open', per_page: 100
            });
            let issue = issues.find(i => i.title === title);

            if (!issue) {
              const res = await github.rest.issues.create({ owner, repo, title, body });
              issue = res.data;
            } else {
              await github.rest.issues.update({ owner, repo, issue_number: issue.number, body });
            }

            const ping = process.env.PING_USER ? `@${process.env.PING_USER}` : '';
            // Add a short comment to trigger a fresh notification
            await github.rest.issues.createComment({
              owner, repo, issue_number: issue.number,
              body: `Cáº­p nháº­t: ${new Date().toISOString()} ${ping}`
            });
            core.setOutput('issue_number', issue.number);
