name: Notify anomalies by email

on:
  # Tá»± cháº¡y sau khi Detect AQI Anomalies hoÃ n táº¥t
  workflow_run:
    workflows: ["Detect AQI Anomalies"]
    types: [completed]
  # Cho phÃ©p cháº¡y tay Ä‘á»ƒ test ngay
  workflow_dispatch:
    inputs:
      demo:
        description: "Gá»­i email demo (khÃ´ng cáº§n anomaly thá»±c)"
        required: false
        default: false
        type: boolean

jobs:
  notify:
    # Chá»‰ gá»­i khi detect thÃ nh cÃ´ng, hoáº·c náº¿u báº¡n cháº¡y tay (workflow_dispatch)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo at detect commit (or default)
        uses: actions/checkout@v4
        with:
          # Khi workflow_run: checkout Ä‘Ãºng commit mÃ  detect Ä‘Ã£ cháº¡y
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || '' }}
          fetch-depth: 2  # Ä‘á»ƒ diff Ä‘Æ°á»£c vá»›i HEAD~1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      # Khi Ä‘Æ°á»£c trigger bá»Ÿi detect, tÃ­nh list file má»›i/sá»­a trong result_anomaly
      - name: Collect changed anomaly files (only on workflow_run)
        id: diff
        if: ${{ github.event_name == 'workflow_run' }}
        run: |
          # Láº¥y cÃ¡c file thay Ä‘á»•i giá»¯a HEAD~1 vÃ  HEAD, giá»›i háº¡n thÆ° má»¥c result_anomaly
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED="$(git diff --name-only HEAD~1 HEAD -- result_anomaly || true)"
          else
            CHANGED="$(git ls-files result_anomaly || true)"
          fi
          echo "Changed files:"
          echo "$CHANGED"
          # Xuáº¥t ra output Ä‘á»ƒ dÃ¹ng á»Ÿ bÆ°á»›c render
          CHANGED_ESCAPED="$(printf "%s" "$CHANGED" | sed -e 's/%/%25/g' -e 's/\r/%0D/g' -e 's/\n/%0A/g')"
          echo "files=$CHANGED_ESCAPED" >> "$GITHUB_OUTPUT"

      # TrÆ°á»ng há»£p cháº¡y tay: táº¡o email demo Ä‘á»ƒ tháº¥y ngay
      - name: Build demo email (only on manual run)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.demo }}
        run: |
          mkdir -p out
          cat > out/anomaly_email.md <<'MD'
          # ðŸš¨ Cáº£nh bÃ¡o báº¥t thÆ°á»ng AQI/GiÃ³ (DEMO)
          | ThÃ nh phá»‘ | Thá»i Ä‘iá»ƒm (UTC) | AQI | GiÃ³ | PhÆ°Æ¡ng phÃ¡p | Nguá»“n |
          |---|---:|---:|---:|---|---|
          | Ho Chi Minh City | 2025-08-16 12:00 | 180 | 12.3 | Z-score, IF | result_anomaly/demo.csv |
          MD

      - name: Render email from result_anomaly (only when files changed)
        if: ${{ github.event_name == 'workflow_run' && steps.diff.outputs.files != '' }}
        env:
          CHANGED_FILES: ${{ steps.diff.outputs.files }}
        run: |
          python notify/render_email.py

      - name: Send mail
        if: hashFiles('out/anomaly_email.md') != ''
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âš ï¸ AQI/GiÃ³ báº¥t thÆ°á»ng â€” ${{ github.repository }}"
          to: ${{ secrets.TO_EMAIL }}
          from: "${{ secrets.FROM_NAME }} <${{ secrets.SMTP_USERNAME }}>"
          content_type: text/html
          html_body: file://out/anomaly_email.md
          convert_markdown: true
